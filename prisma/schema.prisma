// Prisma schema for Roadmap-Nextjs-Backend
// This schema includes tables for better-auth and the voting system

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// better-auth required tables
// ============================================

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions Session[]
  accounts Account[]
  apiKeys  apikey[]

  @@map("user")
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================
// better-auth API Key plugin table
// ============================================

model apikey {
  id                  String    @id @default(uuid())
  name                String?
  start               String?
  prefix              String?
  key                 String    @unique
  userId              String
  refillInterval      Int?
  refillAmount        Int?
  lastRefillAt        DateTime?
  enabled             Boolean   @default(true)
  rateLimitEnabled    Boolean   @default(true)
  rateLimitTimeWindow Int?
  rateLimitMax        Int?
  requestCount        Int       @default(0)
  remaining           Int?
  lastRequest         DateTime?
  expiresAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  permissions         String?
  metadata            String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("apikey")
}

// ============================================
// Application tables
// ============================================

model Feature {
  id          String   @id @default(uuid())
  title       String   @db.VarChar(255)
  description String   @db.Text
  status      String   @db.VarChar(50)
  appVersion  String?  @map("app_version") @db.VarChar(50)
  voteCount   Int      @default(0) @map("vote_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  votes VotedUser[]

  @@map("features")
}

model VotedUser {
  id        String   @id @default(uuid())
  userUuid  String   @map("user_uuid")
  featureId String   @map("feature_id")
  createdAt DateTime @default(now()) @map("created_at")

  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([userUuid, featureId])
  @@map("voted_users")
}
